<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopZone - Modern E-Ticaret</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === GELİŞTİRİLMİŞ CSS === */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 10px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        #app {
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header */
        .header {
            background: white;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--border);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1.25rem;
            padding-right: 3rem;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--light);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .search-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 50px;
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }

        .nav-link:hover {
            background: var(--light);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: var(--shadow);
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-menu {
            position: relative;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 250px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-top: 0.5rem;
            display: none;
            z-index: 1001;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .user-dropdown.show {
            display: block;
        }

        .user-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .user-email {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            text-decoration: none;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .dropdown-item:hover {
            background: var(--light);
            color: var(--primary);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1));
            border-radius: var(--radius);
            padding: 4rem 3rem;
            margin-bottom: 3rem;
            text-align: center;
            border: 1px solid rgba(79, 70, 229, 0.2);
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--gray);
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        /* Categories */
        .categories {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding: 1rem 0;
            -webkit-overflow-scrolling: touch;
        }

        .category-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border);
            border-radius: 50px;
            background: white;
            color: var(--dark);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .category-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
            box-shadow: var(--shadow);
        }

        /* Product Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .product-card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
            /* DÜZELTME: İçerik yönetimini kolaylaştırmak için */
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .product-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: var(--success);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: var(--transition);
            border-bottom: 1px solid var(--border); /* Yeni: Görsel ayrım */
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .product-content {
            /* DÜZELTME: Padding ve esneklik */
            padding: 1.25rem 1.5rem;
            flex-grow: 1; /* Esnekliği koru */
            display: flex;
            flex-direction: column;
        }

        .product-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .product-description {
            /* DÜZELTME: Düzgün görünüm için satır limiti */
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 2 satırla sınırla */
            -webkit-box-orient: vertical;
        }

        .product-footer {
            /* DÜZELTME: Alt kısma itmek için */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px dashed var(--border); 
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--warning);
            font-size: 0.9rem;
        }

        /* Login Page */
        .login-container {
            max-width: 400px;
            margin: 3rem auto;
        }

        .login-card {
            /* login-card'ı profil kartı olarak kullanmak için adını değiştirmedim, stilleri aynı kaldı */
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 2rem;
            text-align: center;
            color: white;
        }

        .login-body {
            padding: 2rem;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--dark);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-block {
            width: 100%;
        }

        /* Cart Page */
        .cart-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .cart-item {
            display: flex;
            align-items: center;
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            gap: 1.5rem;
        }

        .cart-item-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: var(--radius);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--light);
            padding: 0.5rem;
            border-radius: 50px;
        }

        .quantity-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: white;
            color: var(--dark);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .quantity-btn:hover {
            background: var(--primary);
            color: white;
        }

        .quantity-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .cart-summary {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-top: 2rem;
            border: 1px solid var(--border);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            color: var(--dark);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--success);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast i {
            font-size: 1.25rem;
        }

        .toast.success i {
            color: var(--success);
        }

        .toast.error i {
            color: var(--danger);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Order History */
        .order-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .order-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-delivered {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Responsive Header ve Ürün Kartları DÜZELTİLDİ */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .search-container {
                margin: 0;
                width: 100%;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            /* Mobil Ürün Kartları Optimizasyonu */
            .products-grid {
                grid-template-columns: repeat(2, 1fr) !important; 
                gap: 1rem;
            }
            
            .product-content {
                padding: 1rem; 
            }
            
            .product-image {
                height: 140px; /* Görseli küçülttük */
            }
            
            .product-title {
                font-size: 1.05rem;
            }
            
            .product-description {
                /* DÜZELTME: Mobil görünümde tek satır */
                -webkit-line-clamp: 1; 
                font-size: 0.85rem;
                margin-bottom: 0.5rem;
            }
            
            .product-price {
                font-size: 1.1rem;
            }
            
            .product-footer button {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }

            /* Sepet Optimizasyonu */
            .cart-item {
                flex-direction: column;
                text-align: center;
            }
            
            .cart-item-actions {
                justify-content: center;
            }
            
            .quantity-control {
                justify-content: center;
            }
            
            .cart-item-details {
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 1rem;
            }
            
            .hero-section {
                padding: 2rem 1rem;
            }
            
            .hero-title {
                font-size: 2rem;
            }
            
            .nav-link {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="container header-container">
                <a href="#home" class="logo" onclick="navigate('home')">
                    <i class="fas fa-store"></i>
                    ShopZone
                </a>
                
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Ürün ara..." id="searchInput" 
                           onkeyup="handleSearch(event)" value="">
                    <button class="search-button" onclick="performSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <nav class="nav-links">
                    <a href="#home" class="nav-link" onclick="navigate('home')">
                        <i class="fas fa-home"></i>
                        <span>Ana Sayfa</span>
                    </a>
                    
                    <a href="#cart" class="nav-link" onclick="navigate('cart')">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Sepet</span>
                        <span class="badge" id="cartBadge" style="display: none;">0</span>
                    </a>
                    
                    <div class="user-menu" id="userMenu">
                        </div>
                </nav>
            </div>
        </header>

        <main class="container main-content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Yükleniyor...</p>
            </div>
            
            <div id="content">
                </div>
        </main>

        <footer style="background: var(--dark); color: white; padding: 3rem 0; margin-top: 4rem;">
            <div class="container">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">ShopZone</h3>
                        <p style="color: #94a3b8;">Modern alışveriş deneyimi için buradayız.</p>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 1rem;">Hızlı Linkler</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <a href="#home" onclick="navigate('home')" style="color: #94a3b8; text-decoration: none;">Ana Sayfa</a>
                            <a href="#cart" onclick="navigate('cart')" style="color: #94a3b8; text-decoration: none;">Sepet</a>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 1rem;">İletişim</h4>
                        <p style="color: #94a3b8;">destek@shopzone.com</p>
                        <p style="color: #94a3b8;">+90 555 123 4567</p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #334155; color: #94a3b8;">
                    <p>© 2024 ShopZone. Tüm hakları saklıdır.</p>
                </div>
            </div>
        </footer>

        <div id="toast" class="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">İşlem başarılı</span>
        </div>

        <div id="orderModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Sipariş Detayları</h3>
                    <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">×</button>
                </div>
                <div class="modal-body">
                    <div id="orderDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============== DÜZELTİLMİŞ JAVASCRIPT KODLARI ===============
        
        // Uygulama durumu
        let appState = {
            user: null,
            cart: [],
            products: [], 
            categories: ['Tümü', 'Telefon', 'Bilgisayar', 'Tablet', 'Kulaklık', 'Saat', 'Konsol'],
            currentCategory: 'Tümü',
            orders: [],
            db: null,
            searchTerm: '',
            filteredProducts: []
        };

        // IndexedDB sürümü, yeni indeks eklediğinizde bunu artırmalısınız
        const DB_VERSION = 3; 

        // =============== UTILITY FUNCTIONS ===============
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('i');
            
            toastMessage.textContent = message;
            
            // Tip'e göre stil ayarla
            toast.className = 'toast';
            toast.classList.add(type);
            
            if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                icon.className = 'fas fa-check-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 0
            }).format(price);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function openModal() {
            document.getElementById('orderModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('orderModal').classList.remove('show');
        }

        // =============== ARAMA FONKSİYONU ===============
        
        function handleSearch(event) {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            appState.searchTerm = searchTerm;
            
            if (event.key === 'Enter' || event.type === 'click') {
                performSearch();
            } else if (event.type === 'keyup') {
                // Gerçek zamanlı arama, performans nedeniyle şimdilik sadece Enter ile çalışıyor
            }
        }

        async function performSearch() {
            const products = appState.products; // Bellekteki ürünleri kullan
            const searchTerm = appState.searchTerm.toLowerCase();
            
            if (searchTerm === '') {
                renderHomePage();
                return;
            }
            
            showLoading();
            
            // Ürünleri arama terimine göre filtrele
            appState.filteredProducts = products.filter(product => {
                return (
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm)
                );
            });
            
            renderFilteredProducts();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            appState.searchTerm = '';
            renderHomePage();
        }

        function renderFilteredProducts() {
            const products = appState.filteredProducts;
            const currentCategory = appState.currentCategory;
            
            // Kategori filtrelemesi de uygula
            let filteredProducts = products;
            if (currentCategory !== 'Tümü') {
                filteredProducts = products.filter(p => p.category === currentCategory);
            }
            
             let productsHTML = '';
            
            if (filteredProducts.length === 0) {
                productsHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>Arama sonucu bulunamadı</h3>
                        <p>"${appState.searchTerm}" için ürün bulunamadı</p>
                        <button class="btn btn-primary" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                            Aramayı Temizle
                        </button>
                    </div>
                `;
            } else {
                productsHTML = filteredProducts.map(product => `
                    <div class="product-card">
                        ${product.stock < 5 ? `<div class="product-badge">Son ${product.stock} Ürün</div>` : ''}
                        <img src="${product.image}" alt="${product.name}" class="product-image">
                        <div class="product-content">
                            <h3 class="product-title">${product.name}</h3>
                            <p class="product-description">${product.description}</p>
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                <div class="product-rating">
                                    ${Array(5).fill().map((_, i) => `
                                        <i class="fas fa-star${i < Math.floor(product.rating) ? '' : '-half-alt'}"></i>
                                    `).join('')}
                                    <span style="color: var(--gray); margin-left: 0.5rem;">(${product.rating})</span>
                                </div>
                                <div style="color: var(--gray); font-size: 0.9rem;">
                                    Stok: ${product.stock}
                                </div>
                            </div>
                            <div class="product-footer">
                                <div class="product-price">${formatPrice(product.price)}</div>
                                <button class="btn btn-primary" onclick="addToCart(${product.id})">
                                    <i class="fas fa-cart-plus"></i>
                                    Sepete Ekle
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            const categoriesHTML = appState.categories.map(category => `
                <button class="category-btn ${category === appState.currentCategory ? 'active' : ''}" 
                        onclick="filterByCategory('${category}')">
                    ${category}
                </button>
            `).join('');
            
            const searchInfo = appState.searchTerm ? 
                `<div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1)); border-radius: var(--radius);">
                    <strong>Arama:</strong> "${appState.searchTerm}" - ${filteredProducts.length} sonuç bulundu
                    <button class="btn btn-sm" onclick="clearSearch()" style="margin-left: 1rem; padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                        <i class="fas fa-times"></i> Temizle
                    </button>
                </div>` : '';
            
            document.getElementById('content').innerHTML = `
                ${searchInfo}
                
                <div style="margin-bottom: 3rem;">
                    <h2 style="margin-bottom: 1.5rem;">Kategoriler</h2>
                    <div class="categories">
                        ${categoriesHTML}
                    </div>
                </div>
                
                <div>
                    <h2 style="margin-bottom: 1.5rem;">
                        ${appState.currentCategory === 'Tümü' ? 'Tüm Ürünler' : appState.currentCategory} 
                        (${filteredProducts.length})
                    </h2>
                    <div class="products-grid">
                        ${productsHTML}
                    </div>
                </div>
            `;
            
            hideLoading();
        }

        // =============== DATABASE OPERATIONS ===============
        
        function initDatabase() {
            return new Promise((resolve, reject) => {
                if (appState.db) {
                    resolve();
                    return;
                }
                
                const request = indexedDB.open('ShopZoneDB_v2', DB_VERSION); 
                
                request.onerror = (event) => {
                    console.error('Veritabanı açılamadı:', event.target.error);
                    reject('Veritabanı açılamadı');
                };
                
                request.onsuccess = (event) => {
                    appState.db = event.target.result;
                    console.log('✅ Veritabanı bağlantısı başarılı');
                    // Başlangıçta tüm ürünleri çek
                    dbOperation('products', 'getAll').then(products => {
                        appState.products = products;
                        resolve();
                    }).catch(reject);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Kullanıcılar (Değişiklik yok)
                    if (!db.objectStoreNames.contains('users')) {
                        const usersStore = db.createObjectStore('users', { keyPath: 'email' });
                        usersStore.createIndex('email', 'email', { unique: true });
                        
                        // Demo kullanıcılar
                        usersStore.add({
                            email: 'demo@shopzone.com',
                            password: 'demo123',
                            name: 'Demo Kullanıcı',
                            role: 'user',
                            createdAt: new Date().toISOString()
                        });
                        
                        usersStore.add({
                            email: 'admin@shopzone.com',
                            password: 'admin123',
                            name: 'Admin Kullanıcı',
                            role: 'admin',
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    // Ürünler (Değişiklik yok)
                    if (!db.objectStoreNames.contains('products')) {
                        const productsStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                        productsStore.createIndex('category', 'category', { unique: false });
                        
                        // Demo ürünler
                        const demoProducts = [
                            {
                                name: 'iPhone 15 Pro',
                                description: 'Yeni nesil iPhone profesyonel modeli',
                                price: 54999,
                                image: 'https://images.unsplash.com/photo-1695048133142-1a20484d2569?w=400&h=300&fit=crop',
                                category: 'Telefon',
                                stock: 15,
                                rating: 4.8
                            },
                            {
                                name: 'MacBook Air M2',
                                description: 'İnce ve hafif dizüstü bilgisayar',
                                price: 35999,
                                image: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=400&h=300&fit=crop',
                                category: 'Bilgisayar',
                                stock: 8,
                                rating: 4.7
                            },
                            {
                                name: 'AirPods Pro',
                                description: 'Gelişmiş gürültü engelleme özellikli kulaklık',
                                price: 8999,
                                image: 'https://images.unsplash.com/photo-1600294037681-c80b4cb5b434?w=400&h=300&fit=crop',
                                category: 'Kulaklık',
                                stock: 25,
                                rating: 4.6
                            },
                            {
                                name: 'iPad Pro',
                                description: 'Profesyonel tablet bilgisayar',
                                price: 28999,
                                image: 'https://images.unsplash.com/photo-1544244015-0df4b3ffc6b0?w=400&h=300&fit=crop',
                                category: 'Tablet',
                                stock: 12,
                                rating: 4.5
                            },
                            {
                                name: 'Apple Watch Ultra',
                                description: 'Gelişmiş spor saat',
                                price: 18999,
                                image: 'https://images.unsplash.com/photo-1434493650001-5d43a6fea0a1?w=400&h=300&fit=crop',
                                category: 'Saat',
                                stock: 20,
                                rating: 4.4
                            },
                            {
                                name: 'Samsung Galaxy S23',
                                description: 'Android işletim sistemli akıllı telefon',
                                price: 32999,
                                image: 'https://images.unsplash.com/photo-1610945265064-0e34e5519bbf?w=400&h=300&fit=crop',
                                category: 'Telefon',
                                stock: 18,
                                rating: 4.3
                            },
                            {
                                name: 'Microsoft Surface Pro',
                                description: '2\'si 1 arada dizüstü bilgisayar',
                                price: 42999,
                                image: 'https://images.unsplash.com/photo-1561154464-82e9adf32764?w=400&h=300&fit=crop',
                                category: 'Bilgisayar',
                                stock: 7,
                                rating: 4.2
                            },
                            {
                                name: 'Sony WH-1000XM5',
                                description: 'Wireless kulaküstü kulaklık',
                                price: 12499,
                                image: 'https://images.unsplash.com/photo-1484704849700-f032a568e944?w=400&h=300&fit=crop',
                                category: 'Kulaklık',
                                stock: 14,
                                rating: 4.7
                            },
                            {
                                name: 'PlayStation 5',
                                description: 'Yeni nesil oyun konsolu',
                                price: 18999,
                                image: 'https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?w=400&h=300&fit=crop',
                                category: 'Konsol',
                                stock: 6,
                                rating: 4.9
                            },
                            {
                                name: 'Nintendo Switch',
                                description: 'Taşınabilir oyun konsolu',
                                price: 9999,
                                image: 'https://images.unsplash.com/photo-1578303512597-81e6cc155b3e?w=400&h=300&fit=crop',
                                category: 'Konsol',
                                stock: 15,
                                rating: 4.6
                            }
                        ];
                        
                        demoProducts.forEach(product => {
                            productsStore.add(product);
                        });
                    }
                    
                    // Sepet (Değişiklik yok)
                    if (!db.objectStoreNames.contains('cart')) {
                        const cartStore = db.createObjectStore('cart', { keyPath: 'id', autoIncrement: true });
                        cartStore.createIndex('productId', 'productId', { unique: false });
                    }
                    
                    // Siparişler (userId index'i eklenmeli)
                    if (!db.objectStoreNames.contains('orders')) {
                        const ordersStore = db.createObjectStore('orders', { keyPath: 'id', autoIncrement: true });
                        // Siparişleri kullanıcının e-postasına göre çekmek için bu indeks kritik
                        ordersStore.createIndex('userId', 'userId', { unique: false }); 
                    }
                };
            });
        }
        
        function dbOperation(storeName, operation, data = null, key = null) {
            return new Promise((resolve, reject) => {
                if (!appState.db) {
                    reject('Veritabanı bağlantısı yok');
                    return;
                }
                
                const transaction = appState.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                let request;
                
                try {
                    switch(operation) {
                        case 'getAll':
                            request = store.getAll();
                            break;
                        case 'get':
                            request = store.get(key);
                            break;
                        case 'add':
                            request = store.add(data);
                            break;
                        case 'put':
                            request = store.put(data);
                            break;
                        case 'delete':
                            request = store.delete(key);
                            break;
                        case 'clear':
                            request = store.clear();
                            break;
                        case 'getByIndex':
                            // data: { indexName: 'userId', indexValue: 'demo@shopzone.com' }
                            const index = store.index(data.indexName);
                            request = index.getAll(data.indexValue);
                            break;
                        default:
                            reject('Geçersiz işlem');
                            return;
                    }
                } catch(e) {
                    reject(`IndexedDB hatası: ${e.message}`);
                    return;
                }
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // =============== AUTH FUNCTIONS (Aynı Kaldı) ===============
        
        function checkAuth() {
            const userData = localStorage.getItem('shopzone_user');
            if (userData) {
                appState.user = JSON.parse(userData);
                updateUserSection();
                return true;
            }
            return false;
        }

        async function login(email, password) {
            try {
                showLoading();
                
                const user = await dbOperation('users', 'get', null, email);
                
                if (!user || user.password !== password) {
                    showToast('E-posta veya şifre hatalı', 'error');
                    hideLoading();
                    return false;
                }
                
                const { password: _, ...userWithoutPassword } = user;
                appState.user = userWithoutPassword;
                localStorage.setItem('shopzone_user', JSON.stringify(userWithoutPassword));
                
                updateUserSection();
                showToast(`Hoş geldiniz, ${user.name}!`);
                hideLoading();
                return true;
                
            } catch (error) {
                console.error('Giriş hatası:', error);
                showToast('Giriş sırasında hata oluştu', 'error');
                hideLoading();
                return false;
            }
        }

        async function register(name, email, password) {
            try {
                showLoading();
                
                const existingUser = await dbOperation('users', 'get', null, email);
                
                if (existingUser) {
                    showToast('Bu e-posta zaten kayıtlı', 'error');
                    hideLoading();
                    return false;
                }
                
                await dbOperation('users', 'add', {
                    email,
                    password,
                    name,
                    role: 'user',
                    createdAt: new Date().toISOString()
                });
                
                const { password: _, ...userWithoutPassword } = { email, name, role: 'user' };
                appState.user = userWithoutPassword;
                localStorage.setItem('shopzone_user', JSON.stringify(userWithoutPassword));
                
                updateUserSection();
                showToast('Kayıt başarılı! Hoş geldiniz.');
                hideLoading();
                return true;
                
            } catch (error) {
                console.error('Kayıt hatası:', error);
                showToast('Kayıt sırasında hata oluştu', 'error');
                hideLoading();
                return false;
            }
        }

        function logout() {
            if (confirm('Çıkış yapmak istediğinize emin misiniz?')) {
                appState.user = null;
                localStorage.removeItem('shopzone_user');
                updateUserSection();
                showToast('Başarıyla çıkış yapıldı');
                navigate('home');
            }
        }

        function updateUserSection() {
            const userMenu = document.getElementById('userMenu');
            
            if (appState.user) {
                userMenu.innerHTML = `
                    <button class="nav-link" onclick="toggleUserDropdown()">
                        <i class="fas fa-user"></i>
                        <span>${appState.user.name.split(' ')[0]}</span>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-header">
                            <div class="user-name">${appState.user.name}</div>
                            <div class="user-email">${appState.user.email}</div>
                        </div>
                        <a href="#" class="dropdown-item" onclick="navigate('profile')">
                            <i class="fas fa-user-circle"></i>
                            <span>Profilim</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="navigate('orders')">
                            <i class="fas fa-history"></i>
                            <span>Siparişlerim</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Çıkış Yap</span>
                        </a>
                    </div>
                `;
            } else {
                userMenu.innerHTML = `
                    <a href="#login" class="nav-link" onclick="navigate('login')">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Giriş Yap</span>
                    </a>
                `;
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // =============== CART FUNCTIONS ===============
        
        async function updateCartCount() {
            try {
                const cartItems = await dbOperation('cart', 'getAll');
                const cartBadge = document.getElementById('cartBadge');
                
                if (cartItems.length > 0) {
                    cartBadge.textContent = cartItems.length;
                    cartBadge.style.display = 'flex';
                } else {
                    cartBadge.style.display = 'none';
                }
            } catch (error) {
                console.error('Sepet sayısı güncellenirken hata:', error);
            }
        }

        async function addToCart(productId) {
            if (!appState.user) {
                showToast('Sepete eklemek için giriş yapmalısınız', 'error');
                navigate('login');
                return;
            }
            
            try {
                showLoading();
                
                const product = appState.products.find(p => p.id === productId);
                
                if (!product) {
                    showToast('Ürün bulunamadı', 'error');
                    hideLoading();
                    return;
                }
                
                const cartItems = await dbOperation('cart', 'getAll');
                const existingItem = cartItems.find(item => item.productId === productId);
                
                if (existingItem) {
                    if (existingItem.quantity >= product.stock) {
                        showToast('Stokta yeterli ürün yok', 'warning');
                        hideLoading();
                        return;
                    }
                    
                    existingItem.quantity += 1;
                    await dbOperation('cart', 'put', existingItem);
                } else {
                    await dbOperation('cart', 'add', {
                        productId,
                        quantity: 1,
                        addedAt: new Date().toISOString()
                    });
                }
                
                await updateCartCount();
                showToast(`${product.name} sepete eklendi`);
                hideLoading();
                
            } catch (error) {
                console.error('Sepete ekleme hatası:', error);
                showToast('Ürün sepete eklenirken hata oluştu', 'error');
                hideLoading();
            }
        }

        async function updateCartItem(itemId, newQuantity) {
            try {
                const cartItem = await dbOperation('cart', 'get', null, itemId);
                
                if (!cartItem) return;
                
                if (newQuantity < 1) {
                    await removeCartItem(itemId);
                    return;
                }
                
                const product = appState.products.find(p => p.id === cartItem.productId);
                
                if (newQuantity > product.stock) {
                    showToast('Stokta yeterli ürün yok', 'warning');
                    return;
                }
                
                cartItem.quantity = newQuantity;
                await dbOperation('cart', 'put', cartItem);
                
                await renderCartPage();
                await updateCartCount();
                
            } catch (error) {
                console.error('Sepet güncelleme hatası:', error);
                showToast('Sepet güncellenirken hata oluştu', 'error');
            }
        }

        async function removeCartItem(itemId) {
            if (!confirm('Bu ürünü sepetten kaldırmak istediğinize emin misiniz?')) {
                return;
            }
            
            try {
                await dbOperation('cart', 'delete', null, itemId);
                showToast('Ürün sepetten kaldırıldı');
                
                await renderCartPage();
                await updateCartCount();
                
            } catch (error) {
                console.error('Sepetten kaldırma hatası:', error);
                showToast('Ürün kaldırılırken hata oluştu', 'error');
            }
        }

        async function clearCart() {
            if (!confirm('Sepetinizi tamamen temizlemek istediğinize emin misiniz?')) {
                return;
            }
            
            try {
                await dbOperation('cart', 'clear');
                showToast('Sepet temizlendi');
                
                await renderCartPage();
                await updateCartCount();
                
            } catch (error) {
                console.error('Sepet temizleme hatası:', error);
                showToast('Sepet temizlenirken hata oluştu', 'error');
            }
        }

        // =============== PAGE RENDER FUNCTIONS (Ana Fonksiyonlar) ===============
        
        async function renderHomePage() {
            showLoading();
            
            try {
                // Ürünleri bellekteki listeden al
                const products = appState.products;
                
                let productsHTML = '';
                
                let filteredProducts = products;
                
                // 1. Arama terimi varsa filtrele
                if (appState.searchTerm) {
                    const searchTermLower = appState.searchTerm.toLowerCase();
                    filteredProducts = products.filter(product => {
                        return (
                            product.name.toLowerCase().includes(searchTermLower) ||
                            product.description.toLowerCase().includes(searchTermLower) ||
                            product.category.toLowerCase().includes(searchTermLower)
                        );
                    });
                }
                
                // 2. Kategoriye göre filtrele
                if (appState.currentCategory !== 'Tümü') {
                    filteredProducts = filteredProducts.filter(p => p.category === appState.currentCategory);
                }
                
                if (filteredProducts.length === 0) {
                    if (appState.searchTerm) {
                         productsHTML = `
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>Arama sonucu bulunamadı</h3>
                                <p>"${appState.searchTerm}" için ürün bulunamadı</p>
                                <button class="btn btn-primary" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                    Aramayı Temizle
                                </button>
                            </div>
                        `;
                    } else {
                         productsHTML = `
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>Bu kategoride ürün bulunmuyor</h3>
                                <p>Diğer kategorileri deneyebilirsiniz</p>
                            </div>
                        `;
                    }
                } else {
                    productsHTML = filteredProducts.map(product => `
                        <div class="product-card">
                            ${product.stock < 5 ? `<div class="product-badge">Son ${product.stock} Ürün</div>` : ''}
                            <img src="${product.image}" alt="${product.name}" class="product-image">
                            <div class="product-content">
                                <h3 class="product-title">${product.name}</h3>
                                <p class="product-description">${product.description}</p>
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <div class="product-rating">
                                        ${Array(5).fill().map((_, i) => `
                                            <i class="fas fa-star${i < Math.floor(product.rating) ? '' : '-half-alt'}"></i>
                                        `).join('')}
                                        <span style="color: var(--gray); margin-left: 0.5rem;">(${product.rating})</span>
                                    </div>
                                    <div style="color: var(--gray); font-size: 0.9rem;">
                                        Stok: ${product.stock}
                                    </div>
                                </div>
                                <div class="product-footer">
                                    <div class="product-price">${formatPrice(product.price)}</div>
                                    <button class="btn btn-primary" onclick="addToCart(${product.id})">
                                        <i class="fas fa-cart-plus"></i>
                                        Sepete Ekle
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                const categoriesHTML = appState.categories.map(category => `
                    <button class="category-btn ${category === appState.currentCategory ? 'active' : ''}" 
                            onclick="filterByCategory('${category}')">
                        ${category}
                    </button>
                `).join('');
                
                const searchInfo = appState.searchTerm ? 
                    `<div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1)); border-radius: var(--radius);">
                        <strong>Arama:</strong> "${appState.searchTerm}" - ${filteredProducts.length} sonuç bulundu
                        <button class="btn btn-sm" onclick="clearSearch()" style="margin-left: 1rem; padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                            <i class="fas fa-times"></i> Temizle
                        </button>
                    </div>` : '';
                
                document.getElementById('content').innerHTML = `
                    <div class="hero-section">
                        <h1 class="hero-title">En İyi Teknoloji Ürünleri</h1>
                        <p class="hero-subtitle">Modern hayatınızı kolaylaştıracak en son teknoloji ürünlerini keşfedin</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-primary" onclick="navigate('cart')">
                                <i class="fas fa-shopping-cart"></i>
                                Sepete Git
                            </button>
                            <button class="btn btn-outline" onclick="scrollToProducts()">
                                <i class="fas fa-arrow-down"></i>
                                Ürünleri Keşfet
                            </button>
                        </div>
                    </div>
                    
                    ${searchInfo}
                    
                    <div style="margin-bottom: 3rem;">
                        <h2 style="margin-bottom: 1.5rem;">Kategoriler</h2>
                        <div class="categories">
                            ${categoriesHTML}
                        </div>
                    </div>
                    
                    <div>
                        <h2 style="margin-bottom: 1.5rem;">
                            ${appState.currentCategory === 'Tümü' ? 'Tüm Ürünler' : appState.currentCategory} 
                            (${filteredProducts.length})
                        </h2>
                        <div class="products-grid">
                            ${productsHTML}
                        </div>
                    </div>
                `;
                
                hideLoading();
                
            } catch (error) {
                console.error('Ana sayfa yüklenirken hata:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Sayfa yüklenirken hata oluştu</h3>
                        <button class="btn btn-primary" onclick="renderHomePage()">
                            Tekrar Dene
                        </button>
                    </div>
                `;
                hideLoading();
            }
        }

        function filterByCategory(category) {
            appState.currentCategory = category;
            renderHomePage();
        }

        function scrollToProducts() {
            const productsSection = document.querySelector('.products-grid');
            if (productsSection) {
                productsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderLoginPage() {
            document.getElementById('content').innerHTML = `
                <div class="login-container">
                    <div class="login-card">
                        <div class="login-header">
                            <h2 style="font-size: 2rem; margin-bottom: 0.5rem;">Hoş Geldiniz</h2>
                            <p>Hesabınıza giriş yapın veya yeni hesap oluşturun</p>
                        </div>
                        <div class="login-body">
                            <div class="form-group">
                                <label class="form-label">E-posta</label>
                                <input type="email" id="loginEmail" class="form-control" placeholder="ornek@email.com" value="demo@shopzone.com">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Şifre</label>
                                <input type="password" id="loginPassword" class="form-control" placeholder="Şifreniz" value="demo123">
                            </div>
                            
                            <button class="btn btn-primary btn-block" onclick="handleLogin()">
                                <i class="fas fa-sign-in-alt"></i>
                                Giriş Yap
                            </button>
                            
                            <div style="text-align: center; margin: 2rem 0;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="flex: 1; height: 1px; background: var(--border);"></div>
                                    <span style="color: var(--gray);">veya</span>
                                    <div style="flex: 1; height: 1px; background: var(--border);"></div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <button class="btn btn-outline btn-block" onclick="showRegisterForm()">
                                    <i class="fas fa-user-plus"></i>
                                    Yeni Hesap Oluştur
                                </button>
                            </div>
                            
                            <div id="registerForm" style="display: none;">
                                <h3 style="margin-bottom: 1.5rem;">Yeni Hesap</h3>
                                
                                <div class="form-group">
                                    <label class="form-label">Ad Soyad</label>
                                    <input type="text" id="registerName" class="form-control" placeholder="Adınız Soyadınız">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">E-posta</label>
                                    <input type="email" id="registerEmail" class="form-control" placeholder="ornek@email.com">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Şifre</label>
                                    <input type="password" id="registerPassword" class="form-control" placeholder="Şifreniz (en az 6 karakter)">
                                </div>
                                
                                <button class="btn btn-success btn-block" onclick="handleRegister()">
                                    <i class="fas fa-user-plus"></i>
                                    Kayıt Ol
                                </button>
                            </div>
                            
                            <div style="margin-top: 2rem; padding: 1rem; background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1)); border-radius: var(--radius);">
                                <p style="margin: 0; font-size: 0.9rem; text-align: center;">
                                    <strong>Demo Hesaplar:</strong><br>
                                    Kullanıcı: demo@shopzone.com / demo123<br>
                                    Admin: admin@shopzone.com / admin123
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            hideLoading();
        }

        async function renderCartPage() {
            if (!appState.user) {
                showToast('Sepeti görüntülemek için giriş yapmalısınız', 'error');
                navigate('login');
                return;
            }
            
            showLoading();
            
            try {
                const cartItems = await dbOperation('cart', 'getAll');
                const products = appState.products; // Bellekteki ürün listesi
                
                let cartHTML = '';
                let totalPrice = 0;
                let totalItems = 0;
                
                // Ürün bilgilerini sepet öğelerine ekleyerek yeni bir liste oluştur
                const cartDetails = cartItems.map(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (!product) return null;
                    
                    const itemTotal = product.price * item.quantity;
                    totalPrice += itemTotal;
                    totalItems += item.quantity;
                    
                    return {
                        ...item,
                        product,
                        itemTotal
                    };
                }).filter(item => item !== null);

                
                if (cartDetails.length === 0) {
                    cartHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>Sepetiniz Boş</h3>
                            <p>Alışverişe başlamak için ürün ekleyin</p>
                            <button class="btn btn-primary" onclick="navigate('home')">
                                <i class="fas fa-store"></i>
                                Alışverişe Devam Et
                            </button>
                        </div>
                    `;
                } else {
                    for (const item of cartDetails) {
                        cartHTML += `
                            <div class="cart-item">
                                <img src="${item.product.image}" alt="${item.product.name}" class="cart-item-image">
                                <div class="cart-item-details">
                                    <h4 class="cart-item-title">${item.product.name}</h4>
                                    <p class="product-description">${item.product.description}</p>
                                    <div class="cart-item-price">${formatPrice(item.product.price)}</div>
                                </div>
                                <div class="cart-item-actions">
                                    <div class="quantity-control">
                                        <button class="quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity - 1})">-</button>
                                        <span class="quantity-value">${item.quantity}</span>
                                        <button class="quantity-btn" onclick="updateCartItem(${item.id}, ${item.quantity + 1})">+</button>
                                    </div>
                                    <div style="font-weight: 700; font-size: 1.25rem;">${formatPrice(item.itemTotal)}</div>
                                    <button class="btn btn-danger" onclick="removeCartItem(${item.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    const taxRate = 0.18;
                    const tax = totalPrice * taxRate;
                    const shippingCost = totalPrice > 50000 ? 0 : 49.90; // Ücretsiz kargo limitini yükselttik
                    const grandTotal = totalPrice + shippingCost + tax;
                    
                    cartHTML += `
                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Ürünler (${totalItems} adet)</span>
                                <span>${formatPrice(totalPrice)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Kargo</span>
                                <span>${shippingCost === 0 ? 'Ücretsiz' : formatPrice(shippingCost)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Vergiler (%${(taxRate * 100).toFixed(0)})</span>
                                <span>${formatPrice(tax)}</span>
                            </div>
                            <div class="summary-row">
                                <strong>Toplam</strong>
                                <strong>${formatPrice(grandTotal)}</strong>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button class="btn btn-danger" onclick="clearCart()">
                                    <i class="fas fa-trash"></i>
                                    Sepeti Temizle
                                </button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="completeOrder()">
                                    <i class="fas fa-credit-card"></i>
                                    Ödeme Yap
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('content').innerHTML = `
                    <div style="margin-bottom: 2rem;">
                        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Sepetim</h1>
                        <p style="color: var(--gray);">${cartDetails.length} ürün, ${totalItems} adet</p>
                    </div>
                    
                    <div class="cart-container">
                        ${cartHTML}
                    </div>
                `;
                
                hideLoading();
                
            } catch (error) {
                console.error('Sepet yüklenirken hata:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Sepet yüklenirken hata oluştu</h3>
                        <button class="btn btn-primary" onclick="renderCartPage()">
                            Tekrar Dene
                        </button>
                    </div>
                `;
                hideLoading();
            }
        }

        async function completeOrder() {
            if (!appState.user) {
                showToast('Sipariş oluşturmak için giriş yapmalısınız', 'error');
                navigate('login');
                return;
            }

            try {
                showLoading();
                const cartItems = await dbOperation('cart', 'getAll');
                const products = appState.products;
                
                if (cartItems.length === 0) {
                    showToast('Sepetiniz boş', 'warning');
                    hideLoading();
                    return;
                }
                
                const orderItems = [];
                let totalPrice = 0;
                const productsToUpdate = [];

                // 1. Stok kontrolü ve sipariş öğelerini oluşturma
                for (const item of cartItems) {
                    const product = products.find(p => p.id === item.productId);

                    if (!product) {
                        showToast(`Ürün ID ${item.productId} bulunamadı!`, 'error');
                        hideLoading();
                        return;
                    }

                    if (item.quantity > product.stock) {
                        showToast(`${product.name} ürününde stok yetersiz (Max: ${product.stock})`, 'error');
                        hideLoading();
                        return;
                    }

                    // Sipariş öğesine ürün detaylarını ekle
                    orderItems.push({
                        productId: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        quantity: item.quantity,
                        itemTotal: product.price * item.quantity
                    });

                    totalPrice += product.price * item.quantity;
                    
                    // Stok güncelleme için ürün listesine ekle
                    product.stock -= item.quantity;
                    productsToUpdate.push(product);
                }
                
                const taxRate = 0.18;
                const tax = totalPrice * taxRate;
                const shippingCost = totalPrice > 50000 ? 0 : 49.90;
                const grandTotal = totalPrice + shippingCost + tax;

                // 2. Sipariş nesnesini oluştur
                const order = {
                    userId: appState.user.email,
                    items: orderItems,
                    total: grandTotal,
                    subtotal: totalPrice,
                    shipping: shippingCost,
                    tax: tax,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                // 3. Siparişi veritabanına ekle (ID alabilmek için)
                const addedOrder = await dbOperation('orders', 'add', order);
                order.id = addedOrder;

                // 4. Stokları güncelle
                for (const product of productsToUpdate) {
                    await dbOperation('products', 'put', product);
                    // Bellekteki ürün listesini de güncelle
                    const index = appState.products.findIndex(p => p.id === product.id);
                    if (index > -1) {
                        appState.products[index] = product;
                    }
                }
                
                // 5. Sepeti temizle
                await dbOperation('cart', 'clear');
                
                showToast('Siparişiniz başarıyla oluşturuldu!', 'success');
                await updateCartCount();
                
                hideLoading();

                // 6. Sipariş detaylarını göster ve sayfaya yönlendir
                setTimeout(() => {
                    renderOrderDetails(order);
                    openModal();
                    navigate('orders');
                }, 500);
                
            } catch (error) {
                console.error('Sipariş hatası:', error);
                showToast('Sipariş oluşturulurken hata oluştu: ' + (error.message || error), 'error');
                hideLoading();
            }
        }
        
        function renderOrderDetails(order) {
            const orderDetails = document.getElementById('orderDetails');
            
            const total = order.total || 0;
            const subtotal = order.subtotal || order.items.reduce((sum, item) => sum + item.itemTotal, 0);
            const tax = order.tax || subtotal * 0.18;
            const shipping = order.shipping === undefined ? (subtotal > 50000 ? 0 : 49.90) : order.shipping;
            
            orderDetails.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Sipariş No:</span>
                        <strong>#${order.id || 'DEMO'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Tarih:</span>
                        <span>${formatDate(order.createdAt)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Durum:</span>
                        <span class="order-status status-${order.status}">
                            ${order.status === 'pending' ? 'Bekliyor' : 
                              order.status === 'delivered' ? 'Teslim Edildi' : 'İptal Edildi'}
                        </span>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 1rem;">Sipariş Özeti</h4>
                ${order.items.map(item => `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                        <span>${item.name} (${formatPrice(item.price)} × ${item.quantity})</span>
                        <span>${formatPrice(item.itemTotal)}</span>
                    </div>
                `).join('')}
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Ara Toplam:</span>
                        <span>${formatPrice(subtotal)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Kargo:</span>
                        <span>${shipping === 0 ? 'Ücretsiz' : formatPrice(shipping)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Vergi:</span>
                        <span>${formatPrice(tax)}</span>
                    </div>
                </div>

                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.25rem;">
                        <span>Toplam Tutar:</span>
                        <span>${formatPrice(total)}</span>
                    </div>
                </div>
            `;
        }

        async function renderOrdersPage() {
            if (!appState.user) {
                showToast('Siparişlerinizi görüntülemek için giriş yapmalısınız', 'error');
                navigate('login');
                return;
            }
            
            showLoading();
            
            try {
                // Kullanıcının siparişlerini IndexedDB'den çek
                const orders = await dbOperation('orders', 'getByIndex', { 
                    indexName: 'userId', 
                    indexValue: appState.user.email 
                });
                
                appState.orders = orders; // Siparişleri uygulama durumuna kaydet
                
                if (orders.length === 0) {
                    document.getElementById('content').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <h3>Sipariş Geçmişiniz Yok</h3>
                            <p>İlk siparişinizi vermek için alışverişe başlayın</p>
                            <button class="btn btn-primary" onclick="navigate('home')">
                                <i class="fas fa-store"></i>
                                Alışverişe Başla
                            </button>
                        </div>
                    `;
                } else {
                    const ordersHTML = orders.map(order => `
                        <div class="order-card">
                            <div class="order-header">
                                <div>
                                    <div style="font-weight: 600;">Sipariş #${order.id}</div>
                                    <div style="color: var(--gray); font-size: 0.9rem;">${formatDate(order.createdAt)}</div>
                                </div>
                                <div class="order-status status-${order.status}">
                                    ${order.status === 'delivered' ? 'Teslim Edildi' : 
                                      order.status === 'pending' ? 'Bekliyor' : 'İptal Edildi'}
                                </div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${order.items.length} ürün</span>
                                    <span style="font-weight: 700;">${formatPrice(order.total)}</span>
                                </div>
                            </div>
                            <button class="btn btn-outline" onclick="viewOrderDetails(${order.id})">
                                <i class="fas fa-eye"></i>
                                Detayları Gör
                            </button>
                        </div>
                    `).join('');
                    
                    document.getElementById('content').innerHTML = `
                        <div style="margin-bottom: 2rem;">
                            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Siparişlerim</h1>
                            <p style="color: var(--gray);">${orders.length} sipariş</p>
                        </div>
                        
                        <div>
                            ${ordersHTML}
                        </div>
                    `;
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Siparişler yüklenirken hata:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Siparişler yüklenirken hata oluştu</h3>
                        <button class="btn btn-primary" onclick="renderOrdersPage()">
                            Tekrar Dene
                        </button>
                    </div>
                `;
                hideLoading();
            }
        }

        async function viewOrderDetails(orderId) {
            try {
                showLoading();
                const order = await dbOperation('orders', 'get', null, orderId);
                
                if (!order) {
                    showToast('Sipariş detayı bulunamadı', 'error');
                    return;
                }
                
                renderOrderDetails(order);
                openModal();
                hideLoading();
            } catch (error) {
                console.error('Sipariş detayı yüklenirken hata:', error);
                showToast('Sipariş detayı yüklenirken hata oluştu', 'error');
                hideLoading();
            }
        }

        // DÜZELTİLMİŞ renderProfilePage
        async function renderProfilePage() {
            if (!appState.user) {
                navigate('login');
                return;
            }
            
            showLoading(); // Yükleme ekranını göster

            try {
                // Kullanıcının siparişlerini IndexedDB'den çek
                const userOrders = await dbOperation('orders', 'getByIndex', { 
                    indexName: 'userId', 
                    indexValue: appState.user.email 
                });
                
                appState.orders = userOrders; // Siparişleri uygulama durumuna kaydet
                
                const totalOrders = userOrders.length;
                const totalSpending = userOrders.reduce((sum, order) => sum + order.total, 0);

                document.getElementById('content').innerHTML = `
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="margin-bottom: 2rem;">
                            <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Profilim</h1>
                            <p style="color: var(--gray);">Kişisel bilgilerinizi görüntüleyin ve güncelleyin</p>
                        </div>
                        
                        <div class="login-card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
                            <h3 style="margin-bottom: 1.5rem;">Hesap Bilgileri</h3>
                            <div class="form-group">
                                <label class="form-label">Ad Soyad</label>
                                <input type="text" class="form-control" value="${appState.user.name}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">E-posta</label>
                                <input type="email" class="form-control" value="${appState.user.email}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rol</label>
                                <input type="text" class="form-control" value="${appState.user.role === 'admin' ? 'Yönetici' : 'Kullanıcı'}" readonly>
                            </div>
                        </div>
                        
                        <div class="login-card" style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 1.5rem;">İstatistikler</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1)); border-radius: var(--radius);">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${totalOrders}</div>
                                    <div style="color: var(--gray);">Toplam Sipariş</div>
                                </div>
                                <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: var(--radius);">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${formatPrice(totalSpending)}</div>
                                    <div style="color: var(--gray);">Toplam Harcama</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                hideLoading();

            } catch(error) {
                console.error('Profil sayfası yüklenirken hata:', error);
                 document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Profil yüklenirken hata oluştu</h3>
                        <p>Lütfen tekrar deneyin.</p>
                    </div>
                `;
                hideLoading();
            }
        }

        // =============== NAVIGATION (Aynı Kaldı) ===============
        
        function navigate(page) {
            window.location.hash = page;
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Navigasyon linklerini etkinleştir
            const navLink = document.querySelector(`.nav-links a[href="#${page}"]`);
            if (navLink) {
                navLink.classList.add('active');
            }
            
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            switch(page) {
                case 'home':
                    renderHomePage();
                    break;
                case 'login':
                    renderLoginPage();
                    break;
                case 'cart':
                    renderCartPage();
                    break;
                case 'orders':
                    renderOrdersPage();
                    break;
                case 'profile':
                    renderProfilePage(); // async fonksiyonu çağırdık
                    break;
                default:
                    renderHomePage();
            }
        }

        // =============== FORM HANDLERS (Aynı Kaldı) ===============
        
        function showRegisterForm() {
            document.getElementById('registerForm').style.display = 'block';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Lütfen tüm alanları doldurun', 'error');
                return;
            }
            
            const success = await login(email, password);
            if (success) {
                navigate('home');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                showToast('Lütfen tüm alanları doldurun', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Şifre en az 6 karakter olmalıdır', 'error');
                return;
            }
            
            const success = await register(name, email, password);
            if (success) {
                navigate('home');
            }
        }

        // =============== INITIALIZATION (Aynı Kaldı) ===============
        
        async function initApp() {
            try {
                console.log('🚀 ShopZone Pro başlatılıyor...');
                showLoading();
                
                // Veritabanını başlat
                await initDatabase(); // Ürünler appState.products'a yüklenecek
                
                // Auth kontrolü
                checkAuth();
                
                // Sepet sayısını güncelle
                await updateCartCount();
                
                // Hash değişimini dinle
                window.addEventListener('hashchange', () => {
                    const page = window.location.hash.slice(1) || 'home';
                    navigate(page);
                });
                
                // Arama input'u için event listener
                document.getElementById('searchInput')?.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
                
                // Modal dışına tıklanınca kapat
                document.getElementById('orderModal')?.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('orderModal')) {
                        closeModal();
                    }
                });
                
                // İlk sayfayı yükle
                const initialPage = window.location.hash.slice(1) || 'home';
                navigate(initialPage);
                
                console.log('✅ ShopZone Pro başarıyla başlatıldı');
                
            } catch (error) {
                console.error('❌ Uygulama başlatılırken hata:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Uygulama başlatılırken hata oluştu</h3>
                        <p>Lütfen sayfayı yenileyin veya internet bağlantınızı kontrol edin</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="fas fa-redo"></i>
                            Sayfayı Yenile
                        </button>
                    </div>
                `;
                hideLoading();
            }
        }

        // Global fonksiyonlar
        window.navigate = navigate;
        window.addToCart = addToCart;
        window.updateCartItem = updateCartItem;
        window.removeCartItem = removeCartItem;
        window.filterByCategory = filterByCategory;
        window.scrollToProducts = scrollToProducts;
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.showRegisterForm = showRegisterForm;
        window.completeOrder = completeOrder;
        window.clearCart = clearCart;
        window.viewOrderDetails = viewOrderDetails;
        window.toggleUserDropdown = toggleUserDropdown;
        window.logout = logout;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.handleSearch = handleSearch;
        window.performSearch = performSearch;
        window.clearSearch = clearSearch;
        window.renderProfilePage = renderProfilePage; // async'i yansıtmak için globalde tutuldu

        // Uygulamayı başlat
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
